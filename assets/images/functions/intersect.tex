---
---

\matrix (A) [collection] {
    \node (a1) {$a_1$}; &
    \node (a2) {$a_2$}; &
    \node (a3) {$a_3$}; &
    \node (a4) {$a_1$}; &
    \node (a5) {$a_4$}; \\
};

\matrix (A') [collection, right=1 of A] {
    \node (b1) {$a_2$}; &
    \node (b2) {$a_1$}; &
    \node (b3) {$a_5$}; &
    \node (b4) {$a_2$}; &
    \node (b5) {$a_1$}; \\
};

\matrix (B) [collection, below=3 of A.south west, anchor=north west] {
    \node (c1) {$a_1$}; &
    \node (c2) {$a_2$}; &
    \node (c3) {$a_1$}; \\
};

\coordinate (x) at ($ (A)!.33!(B) $);
\coordinate (rule) at (a1 |- x);
\draw [name path=p1, flow] (a1) -- (c1 |- rule);
\draw [name path=p2, flow ->] (b2) |- (c1 |- rule) -- (c1);

\coordinate (x) at ($ (A)!.5!(B) $);
\coordinate (rule) at (a1 |- x);
\draw [name path=p3, flow] (a2) -- (c2 |- rule);
\draw [name path=p4, flow ->] (b1) |- (c2 |- rule) -- (c2);

\coordinate (x) at ($ (A)!.66!(B) $);
\coordinate (rule) at (a1 |- x);
\draw [name path=p5, flow] (a4) -- (a4 |- rule);
\draw [name path=p6, flow ->] (b5) |- (a4 |- rule) -| (c3);

\draw [flow, name intersections={of=p2 and p3, by={a}}] (a) pic {jump=90};
\draw [flow, name intersections={of=p2 and p4, by={a}}] (a) pic {jump=90};
\draw [flow, name intersections={of=p4 and p5, by={a}}] (a) pic {jump=90};
\draw [flow, name intersections={of=p2 and p5, by={a}}] (a) pic {jump=90};
